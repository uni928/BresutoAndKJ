<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ブレインストーミング・グルーピングツール（IndexedDB版）</title>
<style>
  :root{
    --bg:#0f172a;           /* slate-900 */
    --panel:#111827;        /* gray-900 */
    --muted:#334155;        /* slate-600 */
    --text:#e5e7eb;         /* gray-200 */
    --text-dim:#cbd5e1;     /* slate-300 */
    --accent:#22c55e;       /* green-500 */
    --accent-2:#3b82f6;     /* blue-500 */
    --danger:#ef4444;       /* red-500 */
    --chip:#1f2937;         /* gray-800 */
    --border:#1f2937;
    --ring:#94a3b8;         /* slate-400 */
    --shadow: 0 8px 24px rgba(0,0,0,.35);
    --radius: 12px;
    --radius-sm: 8px;
    --gap: 14px;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; background:linear-gradient(180deg, #0b1220, #0b1220 60%, #0a1020);
    color:var(--text); font:16px/1.6 system-ui, -apple-system, "Segoe UI", Roboto, "Hiragino Sans", "Noto Sans JP", "Yu Gothic UI", sans-serif;
    letter-spacing:.02em;
  }
  header{
    position:sticky; top:0; z-index:10;
    background:rgba(15,23,42,.85); backdrop-filter: blur(6px);
    border-bottom:1px solid var(--border);
  }
  .container{max-width:1100px; margin:0 auto; padding:18px 16px;}
  .title{
    display:flex; align-items:center; gap:12px; font-weight:700; font-size:20px;
  }
  .title .badge{font-size:12px; padding:2px 8px; border:1px solid var(--border); border-radius:999px; color:var(--text-dim)}
  nav.tabs{display:flex; gap:8px; margin-top:12px;}
  nav.tabs button{
    appearance:none; border:1px solid var(--border); background:var(--panel); color:var(--text);
    padding:10px 14px; border-radius:999px; cursor:pointer; transition:.15s ease; font-weight:600;
  }
  nav.tabs button[aria-selected="true"]{border-color:var(--accent); box-shadow:0 0 0 3px rgba(34,197,94,.25)}
  main{max-width:1100px; margin:24px auto; padding:0 16px 60px}
  section[role="tabpanel"]{display:none}
  section[role="tabpanel"][data-active="true"]{display:block}

  .card{
    background:rgba(255,255,255,.02); border:1px solid var(--border); border-radius:var(--radius); box-shadow:var(--shadow);
  }
  .input-row{display:flex; gap:10px; align-items:center}
  .input-row input[type="text"]{
    flex:1; background:var(--panel); color:var(--text); border:1px solid var(--border);
    padding:12px 12px; border-radius:10px; outline:none; transition:.15s;
  }
  .input-row input[type="text"]:focus{border-color:var(--ring); box-shadow:0 0 0 3px rgba(148,163,184,.25)}
  .btn{
    appearance:none; border:1px solid var(--border); background:#101827; color:var(--text);
    padding:10px 14px; border-radius:10px; font-weight:700; cursor:pointer; transition:.15s; white-space:nowrap;
  }
  .btn:hover{transform:translateY(-1px)}
  .btn.primary{background:var(--accent); border-color:transparent; color:#0b1220}
  .btn.ghost{background:transparent}
  .btn.warn{background:transparent; border-color:var(--danger); color:#fecaca}
  .btn.small{padding:6px 10px; font-weight:600; border-radius:9px}

  .toolbar{
    display:flex; gap:10px; flex-wrap:wrap; align-items:center; justify-content:space-between; margin:18px 0;
  }
  .toolbar .left, .toolbar .right{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
  .search{
    display:flex; align-items:center; gap:8px; background:var(--panel); border:1px solid var(--border);
    padding:8px 12px; border-radius:10px;
  }
  .search input{
    background:transparent; border:none; outline:none; color:var(--text); min-width:220px;
  }

  .table{width:100%; border-collapse:separate; border-spacing:0 8px}
  .row{
    display:grid; grid-template-columns: 1fr minmax(180px, 340px) 140px;
    gap:12px; align-items:center; padding:10px 12px; border:1px solid var(--border); border-radius:12px; background:rgba(16,24,39,.7)
  }
  .row .title-text{font-weight:600}
  .chips{display:flex; gap:6px; flex-wrap:wrap}
  .chip{
    display:inline-flex; gap:6px; align-items:center; padding:6px 10px; border-radius:999px;
    background:var(--chip); border:1px solid var(--border); font-size:13px; line-height:1;
  }
  .chip .dot{width:8px; height:8px; border-radius:50%}
  .chip .x{cursor:pointer; opacity:.9}
  .muted{color:var(--text-dim)}
  .group-header{
    margin:24px 2px 10px; color:#c7f9cc; font-weight:800; letter-spacing:.02em
  }

  /* グループタブ */
  .split{
    display:grid; grid-template-columns: 260px 1fr; gap:16px;
  }
  .panel{padding:16px}
  .group-list{display:flex; flex-direction:column; gap:8px}
  .group-item{
    display:flex; align-items:center; justify-content:space-between; gap:10px;
    padding:10px 12px; background:rgba(16,24,39,.7); border:1px solid var(--border); border-radius:10px; cursor:pointer; transition:.15s
  }
  .group-item:hover{transform:translateX(2px)}
  .group-item[data-active="true"]{outline:2px solid var(--accent); background:rgba(34,197,94,.08)}
  .count{font-weight:800; color:#a7f3d0; font-feature-settings:"tnum" 1, "cv01" 1}
  .group-items{display:grid; grid-template-columns: repeat(auto-fill, minmax(280px,1fr)); gap:12px}
  .card-item{padding:14px; border:1px solid var(--border); border-radius:12px; background:rgba(16,24,39,.7)}
  .card-item .actions{display:flex; gap:8px; margin-top:10px}

  dialog{
    color:var(--text); border:1px solid var(--border); background:#0b1220; border-radius:12px; padding:0; box-shadow:var(--shadow); width:min(560px, 92vw)
  }
  dialog::backdrop{background:rgba(0,0,0,.5)}
  .dlg-head{padding:14px 16px; border-bottom:1px solid var(--border); display:flex; align-items:center; justify-content:space-between}
  .dlg-body{padding:16px}
  .dlg-foot{padding:12px 16px; border-top:1px solid var(--border); display:flex; gap:10px; justify-content:flex-end}
  .grid{
    display:grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap:10px;
  }
  .check{
    display:flex; gap:8px; align-items:center; background:rgba(255,255,255,.02); border:1px solid var(--border);
    padding:8px 10px; border-radius:10px
  }
  details{border:1px dashed var(--border); padding:10px 12px; border-radius:10px}
  details[open]{background:rgba(255,255,255,.02)}
  details .inline{display:flex; gap:8px; margin-top:10px}

  /* ヘルプ */
  .help{margin-top:14px; color:var(--text-dim); font-size:14px}
  .help code{background:rgba(255,255,255,.06); padding:2px 6px; border-radius:6px}

  /* トースト */
  .toast{
    position:fixed; right:16px; bottom:16px; background:#111827; border:1px solid var(--border); border-radius:10px;
    padding:10px 12px; box-shadow:var(--shadow); opacity:0; transform:translateY(6px); transition:.2s;
  }
  .toast[data-show="true"]{opacity:1; transform:none}
  .sr-only{position:absolute; width:1px; height:1px; padding:0; margin:-1px; overflow:hidden; clip:rect(0,0,0,0); white-space:nowrap; border:0}
</style>
</head>
<body>
  <header>
    <div class="container">
      <div class="title">
        <span>🧠 ブレインストーミング・グルーピングツール</span>
        <span class="badge">IndexedDB 保存</span>
      </div>
      <nav class="tabs" role="tablist" aria-label="ビュー切替">
        <button role="tab" aria-selected="true" data-tab="input">入力</button>
        <button role="tab" aria-selected="false" data-tab="groups">グループ</button>
      </nav>
    </div>
  </header>

  <main>
    <!-- 入力タブ -->
    <section id="tab-input" role="tabpanel" aria-labelledby="入力" data-active="true">
      <div class="card" style="padding:16px">
        <form id="addForm" autocomplete="off">
          <div class="input-row">
            <label for="newItem" class="sr-only">新しい項目</label>
            <input id="newItem" type="text" placeholder="新しい項目を入力して Enter または『追加』" maxlength="120" required />
            <button class="btn primary" type="submit" title="項目を追加">追加</button>
          </div>
          <div class="help">追加後に「タグ編集」でグループを付与できます。複数グループに所属できます。</div>
        </form>
      </div>

      <div class="toolbar">
        <div class="left">
          <div class="search" role="search">
            <svg width="16" height="16" viewBox="0 0 24 24" aria-hidden="true"><path fill="currentColor" d="M15.5 14h-.79l-.28-.27A6.471 6.471 0 0 0 16 9.5 6.5 6.5 0 1 0 9.5 16a6.471 6.471 0 0 0 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5M9.5 14A4.5 4.5 0 1 1 14 9.5 4.505 4.505 0 0 1 9.5 14"/></svg>
            <input id="searchInput" type="text" placeholder="項目を検索" />
          </div>
          <button id="sortBtn" class="btn small" type="button" title="並び替えを切り替え">並び替え：<span id="sortLabel">追加順</span></button>
        </div>
        <div class="right">
          <button id="mindmapBtn" class="btn ghost small" type="button" title="マインドマップを別タブで開く">マインドマップ</button>
          <button id="exportBtn" class="btn ghost small" type="button">エクスポート</button>
          <label class="btn ghost small" for="importInput" title="JSONを読み込み">インポート</label>
          <input id="importInput" type="file" accept="application/json" style="display:none" />
          <button id="clearBtn" class="btn warn small" type="button" title="すべて削除">全削除</button>
        </div>
      </div>

      <div id="list" class="table" aria-live="polite"></div>
    </section>

    <!-- グループタブ -->
    <section id="tab-groups" role="tabpanel" aria-labelledby="グループ">
      <div class="split">
        <aside class="card panel">
          <div class="search" style="margin-bottom:12px">
            <svg width="16" height="16" viewBox="0 0 24 24" aria-hidden="true"><path fill="currentColor" d="M15.5 14h-.79l-.28-.27A6.471 6.471 0 0 0 16 9.5 6.5 6.5 0 1 0 9.5 16a6.471 6.471 0 0 0 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5M9.5 14A4.5 4.5 0 1 1 14 9.5 4.505 4.505 0 0 1 9.5 14"/></svg>
            <input id="groupSearch" type="text" placeholder="このタブ内で検索" />
          </div>
          <div class="group-list" id="groupList" aria-label="グループ一覧"></div>
          <details style="margin-top:12px">
            <summary>＋ 新規グループを作成</summary>
            <div class="inline">
              <input id="newGroupNameSidebar" type="text" placeholder="グループ名（例：市場/技術/課題）" />
              <button id="createGroupSidebar" class="btn small" type="button">作成</button>
            </div>
            <div class="help">同名は作成できません。</div>
          </details>
          <div class="help" style="margin-top:12px">
            <strong>グループ外（自動）</strong>はグループ未設定の項目です。自動で出入りします。
          </div>
        </aside>

        <section>
          <div class="toolbar" style="margin-top:0">
            <div class="left"><h3 id="groupHeading" style="margin:0">全ての項目</h3></div>
            <div class="right">
              <button id="toInputTab" class="btn ghost small" type="button">入力タブへ</button>
            </div>
          </div>
          <div id="groupItems" class="group-items" aria-live="polite"></div>
        </section>
      </div>
    </section>
  </main>

  <!-- タグ編集ダイアログ -->
  <dialog id="tagDialog" aria-labelledby="dlgTitle">
    <div class="dlg-head">
      <div>
        <div id="dlgTitle" style="font-weight:800">グループ設定</div>
        <div class="muted" style="font-size:13px">複数選択できます。<strong>グループ外（自動）</strong>は未設定の時に自動で適用されます。</div>
      </div>
      <button class="btn small ghost" type="button" data-dismiss>閉じる</button>
    </div>
    <div class="dlg-body">
      <div id="dlgGroupChecks" class="grid" role="group" aria-label="グループ選択肢"></div>
      <details style="margin-top:12px">
        <summary>＋ 新しいグループを作成</summary>
        <div class="inline">
          <input id="newGroupNameDlg" type="text" placeholder="グループ名を入力" />
          <button id="createGroupDlg" class="btn small" type="button">作成 & 選択</button>
        </div>
      </details>
    </div>
    <div class="dlg-foot">
      <button class="btn ghost" type="button" data-dismiss>キャンセル</button>
      <button class="btn primary" type="button" id="saveTagsBtn">保存</button>
    </div>
  </dialog>

  <div id="toast" class="toast" role="status" aria-live="polite"></div>

<script>
(function(){
  // ===== IndexedDB minimal helper =====
  const DB_NAME = 'brainstormDB';
  const DB_VERSION = 1;
  const STORE_ITEMS = 'items';
  const STORE_GROUPS = 'groups';

  function openDB(){
    return new Promise((resolve, reject)=>{
      const req = indexedDB.open(DB_NAME, DB_VERSION);
      req.onupgradeneeded = (e)=>{
        const db = req.result;
        if(!db.objectStoreNames.contains(STORE_ITEMS)){
          db.createObjectStore(STORE_ITEMS, { keyPath: 'id' });
        }
        if(!db.objectStoreNames.contains(STORE_GROUPS)){
          db.createObjectStore(STORE_GROUPS, { keyPath: 'id' });
        }
      };
      req.onsuccess = ()=> resolve(req.result);
      req.onerror = ()=> reject(req.error);
    });
  }

  function tx(db, storeNames, mode='readonly'){ return db.transaction(storeNames, mode); }
  function getAll(db, store){
    return new Promise((res, rej)=>{
      const r = tx(db, [store]).objectStore(store).getAll();
      r.onsuccess = ()=> res(r.result || []);
      r.onerror = ()=> rej(r.error);
    });
  }
  function put(db, store, value){
    return new Promise((res, rej)=>{
      const r = tx(db, [store], 'readwrite').objectStore(store).put(value);
      r.onsuccess = ()=> res(true);
      r.onerror = ()=> rej(r.error);
    });
  }
  function bulkPut(db, store, values){
    return new Promise((res, rej)=>{
      const t = tx(db, [store], 'readwrite');
      const os = t.objectStore(store);
      values.forEach(v=> os.put(v));
      t.oncomplete = ()=> res(true);
      t.onerror = ()=> rej(t.error);
    });
  }
  function del(db, store, key){
    return new Promise((res, rej)=>{
      const r = tx(db, [store], 'readwrite').objectStore(store).delete(key);
      r.onsuccess = ()=> res(true);
      r.onerror = ()=> rej(r.error);
    });
  }
  function clearStore(db, store){
    return new Promise((res, rej)=>{
      const r = tx(db, [store], 'readwrite').objectStore(store).clear();
      r.onsuccess = ()=> res(true);
      r.onerror = ()=> rej(r.error);
    });
  }

  // ===== App State =====
  const els = {
    tabs: document.querySelectorAll('nav.tabs button[role="tab"]'),
    tabPanels: {
      input: document.getElementById('tab-input'),
      groups: document.getElementById('tab-groups'),
    },
    addForm: document.getElementById('addForm'),
    newItem: document.getElementById('newItem'),
    list: document.getElementById('list'),
    searchInput: document.getElementById('searchInput'),
    sortBtn: document.getElementById('sortBtn'),
    sortLabel: document.getElementById('sortLabel'),
    exportBtn: document.getElementById('exportBtn'),
    mindmapBtn: document.getElementById('mindmapBtn'),
    importInput: document.getElementById('importInput'),
    clearBtn: document.getElementById('clearBtn'),

    groupSearch: document.getElementById('groupSearch'),
    groupList: document.getElementById('groupList'),
    groupItems: document.getElementById('groupItems'),
    groupHeading: document.getElementById('groupHeading'),
    toInputTab: document.getElementById('toInputTab'),
    newGroupNameSidebar: document.getElementById('newGroupNameSidebar'),
    createGroupSidebar: document.getElementById('createGroupSidebar'),

    dlg: document.getElementById('tagDialog'),
    dlgGroupChecks: document.getElementById('dlgGroupChecks'),
    newGroupNameDlg: document.getElementById('newGroupNameDlg'),
    createGroupDlg: document.getElementById('createGroupDlg'),
    saveTagsBtn: document.getElementById('saveTagsBtn'),
    toast: document.getElementById('toast'),
  };

  const state = {
    db: null,
    items: [],
    groups: [], // [{id, name}]
    ui: {
      sortMode: 'created', // 'created' | 'group'
      query: '',
      groupQuery: '',
      activeGroupId: 'all',
    },
    dlgTargetId: null,
  };

  // ===== Utilities =====
  const uid = ()=>'i'+Date.now().toString(36)+Math.random().toString(36).slice(2,8);
  const normalize = s=> (s||'').trim();
  const byName = (a,b)=> a.name.localeCompare(b.name,'ja');
  const byText = (a,b)=> a.text.localeCompare(b.text,'ja');
  const toast = (msg)=>{ els.toast.textContent = msg; els.toast.dataset.show = 'true'; setTimeout(()=> delete els.toast.dataset.show, 1800); };
  const colorFromString = (s)=>{ let h=0; for(let i=0;i<s.length;i++){ h = s.charCodeAt(i)+((h<<5)-h);} h=Math.abs(h)%360; return `hsl(${h},70%,55%)`; };

  // ===== Data Ops (IndexedDB) =====
  async function loadAll(){
    const [items, groups] = await Promise.all([
      getAll(state.db, STORE_ITEMS),
      getAll(state.db, STORE_GROUPS)
    ]);
    state.items = Array.isArray(items)? items:[];
    state.groups = Array.isArray(groups)? groups:[];
  }

  async function migrateFromLocalStorageIfNeeded(){
    try{
      const LS_KEY = 'brainstorm.v1';
      const raw = localStorage.getItem(LS_KEY);
      if(!raw) return;
      // Only migrate if DB empty
      if(state.items.length===0 && state.groups.length===0){
        const data = JSON.parse(raw);
        if(Array.isArray(data.items) || Array.isArray(data.groups)){
          await bulkPut(state.db, STORE_ITEMS, (data.items||[]));
          await bulkPut(state.db, STORE_GROUPS, (data.groups||[]));
          await loadAll();
          toast('ローカルストレージのデータをIndexedDBへ移行しました');
        }
      }
      localStorage.removeItem(LS_KEY);
    }catch(e){ /* ignore */ }
  }

  async function addItem(text){
    const t = normalize(text); if(!t){ toast('項目を入力してください'); return; }
    const item = { id: uid(), text: t, groups: [], createdAt: Date.now() };
    await put(state.db, STORE_ITEMS, item);
    state.items.unshift(item);
    toast('追加しました');
  }
  async function removeItem(id){
    await del(state.db, STORE_ITEMS, id);
    state.items = state.items.filter(i=>i.id!==id);
    toast('削除しました');
  }
  async function updateItemGroups(id, groupNames){
    const it = state.items.find(i=>i.id===id); if(!it) return;
    it.groups = groupNames.slice().sort((a,b)=>a.localeCompare(b,'ja'));
    await put(state.db, STORE_ITEMS, it);
  }
  async function createGroup(name){
    const nm = normalize(name);
    if(!nm){ toast('グループ名を入力してください'); return null; }
    if(nm==='グループ外' || nm==='グループ外（自動）'){ toast('「グループ外（自動）」は作成できません'); return null; }
    if(state.groups.some(g=>g.name===nm)){ toast('同名のグループが既にあります'); return null; }
    const g = { id: 'g'+uid(), name: nm };
    await put(state.db, STORE_GROUPS, g);
    state.groups.push(g);
    return g;
  }
  function getGroupById(id){ return state.groups.find(g=>g.id===id); }
  function getAllGroupsForUI(){ return [{id:'all', name:'全て'}, {id:'__ungrouped', name:'グループ外（自動）'}, ...state.groups.slice().sort(byName)]; }
  function countItemsInGroup(groupId){
    if(groupId==='all') return state.items.length;
    if(groupId==='__ungrouped') return state.items.filter(it=> (it.groups||[]).length===0).length;
    const g = getGroupById(groupId); if(!g) return 0;
    return state.items.filter(it=> (it.groups||[]).includes(g.name)).length;
  }

  // ===== Rendering (same UI as前版) =====
  function renderAll(){
    els.sortLabel.textContent = state.ui.sortMode==='created' ? '追加順' : 'グループ順';
    renderList(); renderGroupList(); renderGroupItems();
  }

  function renderList(){
    const q = state.ui.query.trim();
    const listEl = els.list; listEl.innerHTML = '';
    let items = state.items.slice();
    if(q){ const terms = q.toLowerCase().split(/\s+/).filter(Boolean);
      items = items.filter(it=> terms.every(tt => it.text.toLowerCase().includes(tt) || (it.groups||[]).some(g=>g.toLowerCase().includes(tt)))); }

    if(state.ui.sortMode==='group'){
      const primary = it=> (it.groups&&it.groups.length)? it.groups.slice().sort((a,b)=>a.localeCompare(b,'ja'))[0] : 'グループ外';
      items.sort((a,b)=>{ const pa=primary(a), pb=primary(b); if(pa!==pb) return pa.localeCompare(pb,'ja'); return (a.createdAt||0)-(b.createdAt||0); });
      let currentHeader=null; if(items.length===0){ listEl.innerHTML='<div class="muted">該当する項目がありません。</div>'; return; }
      items.forEach(it=>{ const p=primary(it); if(p!==currentHeader){ currentHeader=p; const h=document.createElement('div'); h.className='group-header'; h.textContent=p; listEl.appendChild(h);} listEl.appendChild(listRow(it)); });
    }else{
      items.sort((a,b)=>(b.createdAt||0)-(a.createdAt||0));
      if(items.length===0){ listEl.innerHTML='<div class="muted">まだ項目がありません。上の入力欄から追加してください。</div>'; }
      else items.forEach(it=> listEl.appendChild(listRow(it)));
    }
  }

  function listRow(it){
    const row = document.createElement('div'); row.className='row';
    const title = document.createElement('div'); title.className='title-text'; title.textContent = it.text;
    const chips = document.createElement('div'); chips.className='chips';
    if(!it.groups || it.groups.length===0){ chips.appendChild(chip('グループ外', true)); }
    else it.groups.forEach(name=> chips.appendChild(chip(name)));
    const ops = document.createElement('div'); ops.style.display='flex'; ops.style.gap='8px';
    const tagBtn = document.createElement('button'); tagBtn.className='btn small'; tagBtn.type='button'; tagBtn.textContent='タグ編集'; tagBtn.addEventListener('click', ()=> openTagDialog(it.id));
    const delBtn = document.createElement('button'); delBtn.className='btn small ghost'; delBtn.type='button'; delBtn.style.borderColor='var(--danger)'; delBtn.style.color='#fecaca'; delBtn.textContent='削除';
    delBtn.addEventListener('click', async ()=>{ if(confirm('この項目を削除しますか？')){ await removeItem(it.id); renderAll(); }});
    ops.appendChild(tagBtn); ops.appendChild(delBtn);
    row.appendChild(title); row.appendChild(chips); row.appendChild(ops);
    return row;
  }

  function chip(name, isMuted=false){
    const el = document.createElement('span'); el.className='chip';
    const dot = document.createElement('span'); dot.className='dot'; dot.style.background = isMuted? 'transparent' : colorFromString(name); if(isMuted) dot.style.outline='1px dashed var(--muted)';
    const txt = document.createElement('span'); txt.textContent=name;
    el.appendChild(dot); el.appendChild(txt); return el;
  }

  function renderGroupList(){
    const q = state.ui.groupQuery.trim().toLowerCase();
    const all = getAllGroupsForUI(); els.groupList.innerHTML='';
    all.forEach(g=>{
      if(g.id!=='all' && q && !g.name.toLowerCase().includes(q)) return;
      const it = document.createElement('div'); it.className='group-item'; it.dataset.active = String(state.ui.activeGroupId===g.id);
      const name = document.createElement('div'); name.style.display='flex'; name.style.alignItems='center'; name.style.gap='8px';
      const dot = document.createElement('span'); dot.className='dot'; dot.style.display='inline-block'; dot.style.width='10px'; dot.style.height='10px'; dot.style.borderRadius='50%';
      dot.style.background = (g.id==='__ungrouped' ? 'transparent' : (g.id==='all' ? 'linear-gradient(90deg, var(--accent), var(--accent-2))' : colorFromString(g.name)));
      if(g.id==='__ungrouped'){ dot.style.outline='1px dashed var(--muted)'; }
      name.appendChild(dot);
      const label = document.createElement('div'); label.textContent = g.name; name.appendChild(label);
      const count = document.createElement('div'); count.className='count'; count.textContent = countItemsInGroup(g.id);
      it.appendChild(name); it.appendChild(count);
      it.addEventListener('click', ()=>{ state.ui.activeGroupId = g.id; renderGroupList(); renderGroupItems(); });
      els.groupList.appendChild(it);
    });
  }

  function renderGroupItems(){
    const id = state.ui.activeGroupId;
    const title = getAllGroupsForUI().find(g=>g.id===id)?.name || '全て';
    els.groupHeading.textContent = title;
    let items = [];
    if(id==='all'){ items = state.items.slice(); }
    else if(id==='__ungrouped'){ items = state.items.filter(it=> (it.groups||[]).length===0); }
    else { const g = getGroupById(id); if(g){ items = state.items.filter(it=> (it.groups||[]).includes(g.name)); } }
    const q = state.ui.groupQuery.trim().toLowerCase(); if(q){ items = items.filter(it=> it.text.toLowerCase().includes(q)); }
    items.sort(byText);
    els.groupItems.innerHTML='';
    if(items.length===0){ els.groupItems.innerHTML='<div class="muted">このグループには項目がありません。</div>'; return; }
    items.forEach(it=>{
      const card = document.createElement('div'); card.className='card-item';
      const t = document.createElement('div'); t.style.fontWeight='700'; t.textContent=it.text;
      const chips = document.createElement('div'); chips.className='chips'; chips.style.marginTop='8px';
      if(!it.groups || it.groups.length===0){ chips.appendChild(chip('グループ外', true)); } else it.groups.forEach(n=> chips.appendChild(chip(n)));
      const actions = document.createElement('div'); actions.className='actions';
      const edit = document.createElement('button'); edit.className='btn small'; edit.type='button'; edit.textContent='タグ編集'; edit.addEventListener('click', ()=> openTagDialog(it.id));
      const del = document.createElement('button'); del.className='btn small ghost'; del.type='button'; del.style.borderColor='var(--danger)'; del.style.color='#fecaca'; del.textContent='削除';
      del.addEventListener('click', async ()=>{ if(confirm('この項目を削除しますか？')){ await removeItem(it.id); renderAll(); }});
      actions.appendChild(edit); actions.appendChild(del);
      card.appendChild(t); card.appendChild(chips); card.appendChild(actions);
      els.groupItems.appendChild(card);
    });
  }

  // ===== Dialog (Tag Editor) =====
  function openTagDialog(itemId){ state.dlgTargetId = itemId; buildDlgChecks(itemId); try{ els.dlg.showModal(); }catch{ els.dlg.show(); } }
  function closeDlg(){ state.dlgTargetId = null; els.dlg.close(); }
  function buildDlgChecks(itemId){
    const it = state.items.find(i=>i.id===itemId);
    const selected = new Set(it? it.groups: []);
    const groups = state.groups.slice().sort(byName);
    els.dlgGroupChecks.innerHTML='';
    if(groups.length===0){ const p=document.createElement('p'); p.className='muted'; p.textContent='まだグループがありません。下の「新しいグループを作成」から追加してください。'; els.dlgGroupChecks.appendChild(p); }
    else{
      groups.forEach(g=>{
        const label=document.createElement('label'); label.className='check';
        const cb=document.createElement('input'); cb.type='checkbox'; cb.value=g.name; cb.checked=selected.has(g.name);
        const dot=document.createElement('span'); dot.className='dot'; dot.style.display='inline-block'; dot.style.width='10px'; dot.style.height='10px'; dot.style.borderRadius='50%'; dot.style.background=colorFromString(g.name);
        const nm=document.createElement('span'); nm.textContent=g.name;
        label.appendChild(cb); label.appendChild(dot); label.appendChild(nm);
        els.dlgGroupChecks.appendChild(label);
      });
    }
  }

  // ===== Event bindings =====
  els.tabs.forEach(btn=>{
    btn.addEventListener('click', ()=>{
      els.tabs.forEach(b=> b.setAttribute('aria-selected', String(b===btn)));
      const tab = btn.dataset.tab; Object.values(els.tabPanels).forEach(p=> p.removeAttribute('data-active'));
      els.tabPanels[tab].setAttribute('data-active','true');
      if(tab==='groups'){ renderGroupList(); renderGroupItems(); }
    });
  });

  els.addForm.addEventListener('submit', async (e)=>{
    e.preventDefault(); await addItem(els.newItem.value); els.newItem.value=''; renderAll();
  });
  els.searchInput.addEventListener('input', ()=>{ state.ui.query = els.searchInput.value; renderList(); });
  els.sortBtn.addEventListener('click', ()=>{ state.ui.sortMode = state.ui.sortMode==='created'? 'group':'created'; els.sortLabel.textContent = state.ui.sortMode==='created'? '追加順':'グループ順'; renderList(); });
  els.exportBtn.addEventListener('click', async ()=>{
    await loadAll();
    const data = JSON.stringify({ items: state.items, groups: state.groups }, null, 2);
    const blob = new Blob([data], {type:'application/json'}); const url = URL.createObjectURL(blob);
    const a=document.createElement('a'); a.href=url; a.download='brainstorm-export.json'; a.click(); URL.revokeObjectURL(url); toast('JSONをダウンロードしました');
  });
// マインドマップ
els.mindmapBtn.addEventListener('click', async ()=>{
  await openMindMap();
});

// エクスポート
els.exportBtn.addEventListener('click', async ()=>{
  await loadAll();
  const data = JSON.stringify({ items: state.items, groups: state.groups }, null, 2);
  const blob = new Blob([data], {type:'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'brainstorm-export.json';
  a.click();
  URL.revokeObjectURL(url);
  toast('JSONをダウンロードしました');
});
  els.importInput.addEventListener('change', async (e)=>{
    const file = e.target.files?.[0]; if(!file) return;
    try{
      const text = await file.text(); const data = JSON.parse(text);
      if(!Array.isArray(data.items) || !Array.isArray(data.groups)) throw new Error('形式が不正です');
      if(!confirm('現在のデータを置き換えます。よろしいですか？')) return;
      await clearStore(state.db, STORE_ITEMS); await clearStore(state.db, STORE_GROUPS);
      await bulkPut(state.db, STORE_ITEMS, data.items); await bulkPut(state.db, STORE_GROUPS, data.groups);
      await loadAll(); renderAll(); toast('インポートしました');
    }catch(err){ alert('読み込みに失敗しました: '+ err.message); }
    e.target.value='';
  });
  els.clearBtn.addEventListener('click', async ()=>{
    if(confirm('全ての項目とグループを削除しますか？この操作は元に戻せません。')){
      await clearStore(state.db, STORE_ITEMS); await clearStore(state.db, STORE_GROUPS);
      await loadAll(); renderAll(); toast('全削除しました');
    }
  });

  els.groupSearch.addEventListener('input', ()=>{ state.ui.groupQuery = els.groupSearch.value; renderGroupList(); renderGroupItems(); });
  els.toInputTab.addEventListener('click', ()=>{ els.tabs[0].click(); });
  els.createGroupSidebar.addEventListener('click', async ()=>{ const name=els.newGroupNameSidebar.value; const g=await createGroup(name); if(g){ els.newGroupNameSidebar.value=''; renderGroupList(); toast('グループを作成しました'); }});

  els.dlg.addEventListener('click', (e)=>{ if(e.target.hasAttribute('data-dismiss')) closeDlg(); });
  els.createGroupDlg.addEventListener('click', async ()=>{ const name=els.newGroupNameDlg.value; const g=await createGroup(name); if(g){ els.newGroupNameDlg.value=''; buildDlgChecks(state.dlgTargetId); const cb=[...els.dlgGroupChecks.querySelectorAll('input[type="checkbox"]')].find(x=>x.value===g.name); if(cb){ cb.checked=true; } renderGroupList(); }});
  els.saveTagsBtn.addEventListener('click', async ()=>{ const id=state.dlgTargetId; const boxes=[...els.dlgGroupChecks.querySelectorAll('input[type="checkbox"]')]; const selected = boxes.filter(b=>b.checked).map(b=>b.value); await updateItemGroups(id, selected); closeDlg(); renderAll(); toast('グループを更新しました'); });

  async function openMindMap(){
    await loadAll();
    const items = state.items.slice();
    const groups = [{id:'__ungrouped', name:'グループ外（自動）'}, ...state.groups.slice().sort((a,b)=> a.name.localeCompare(b.name,'ja'))];

    const payload = { items, groups };
    const safe = JSON.stringify(payload).replace(/</g,'\u003c');
    const html = buildMindMapHTML(safe);
    const w = window.open('about:blank','_blank');
    if(!w){ alert('ポップアップがブロックされました。許可してください。'); return; }
    w.document.open();
    w.document.write(html);
    w.document.close();
  }

  function buildMindMapHTML(jsonSafe){
    return `<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>マインドマップ</title>
<style>
  html,body{height:100%; margin:0; background:#0b1220; color:#e5e7eb; font:14px/1.5 system-ui, -apple-system, Segoe UI, Roboto, Noto Sans JP, sans-serif}
  header{position:sticky; top:0; padding:10px 14px; background:rgba(10,16,32,.85); backdrop-filter:blur(6px); border-bottom:1px solid #1f2937}
  .row{display:flex; align-items:center; gap:8px}
  .hint{opacity:.8}
  #wrap{position:relative; width:100%; height:calc(100% - 52px)}
  svg{width:100%; height:100%; display:block}
  .g-node text{font-weight:700; text-anchor:middle}
  .g-node circle{fill:#0f172a; stroke:#94a3b8; stroke-width:2}
  .i-node circle{fill:#1f2937; stroke:#334155}
  .link{stroke:#334155; stroke-width:1}
  .legend{position:absolute; left:12px; bottom:12px; background:#0f172a; border:1px solid #1f2937; border-radius:10px; padding:8px 10px}
  .chip{display:inline-flex; align-items:center; gap:6px; border:1px solid #1f2937; padding:4px 8px; border-radius:999px; margin:2px}
  .dot{width:10px; height:10px; border-radius:50%}
.g-node text, .i-node text {
  fill: #e5e7eb;  /* 明るい文字色 */
}

.i-node circle {
  r: 10;          /* ノード円を大きく */
}

.g-node circle {
  r: 26;          /* グループ円を大きく */
}

</style>
</head>
<body>
  <header class="row">
    <strong>🗺️ マインドマップ</strong>
    <span class="hint">— グループは外周、項目は内側に配置。項目は所属グループへ線で接続されます。</span>
  </header>
  <div id="wrap">
    <svg id="svg" viewBox="0 0 1000 800" preserveAspectRatio="xMidYMid meet" aria-label="mindmap"></svg>
    <div id="legend" class="legend"></div>
  </div>
<script>
const DATA = JSON.parse('${jsonSafe}');
const svg = document.getElementById('svg');
const NS = 'http://www.w3.org/2000/svg';
// 内側のテンプレ展開を避けるため文字列連結に変更
function colorFromString(s){
  let h=0; for(let i=0;i<s.length;i++){ h = s.charCodeAt(i)+((h<<5)-h); }
  h=Math.abs(h)%360;
  return 'hsl(' + h + ',70%,55%)';
}

function layout(){
  const w = svg.clientWidth || 1000; const h = svg.clientHeight || 800;
  svg.setAttribute('viewBox', '0 0 ' + w + ' ' + h);
  const cx = w/2, cy = h/2; const R = Math.min(w,h)*0.38; const rInner = R*0.7;
  const groups = DATA.groups;
  const n = Math.max(groups.length, 3);
  const angleStep = Math.PI*2/n;
  const gPos = new Map();
  groups.forEach((g,idx)=>{
    const ang = -Math.PI/2 + idx*angleStep;
    const x = cx + Math.cos(ang)*R;
    const y = cy + Math.sin(ang)*R;
    gPos.set(g.name, {x,y,ang});
  });

  while(svg.firstChild) svg.removeChild(svg.firstChild);

  const links = [];
  const iPos = new Map();
  const byGroup = new Map();
  DATA.items.forEach(it=>{
    const groupsOf = (it.groups && it.groups.length)? it.groups.slice().sort((a,b)=> a.localeCompare(b,'ja')): ['グループ外（自動）'];
    const primary = groupsOf[0];
    if(!byGroup.has(primary)) byGroup.set(primary, []);
    byGroup.get(primary).push(it);
  });

  byGroup.forEach((arr, gname)=>{
    const base = gPos.get(gname) || {x:cx, y:cy, ang:0};
    const k = arr.length;
    arr.forEach((it, i)=>{
      const ang = base.ang + (i/k - 0.5) * (Math.PI/1.6);
      const x = base.x + Math.cos(ang)*(-R*0.35);
      const y = base.y + Math.sin(ang)*(-R*0.35);
      iPos.set(it.id, {x,y});
    });
  });

  DATA.items.forEach(it=>{
    const gs = (it.groups && it.groups.length)? it.groups : ['グループ外（自動）'];
    gs.forEach(gn=>{
      const g = gPos.get(gn);
      const p = iPos.get(it.id);
      if(g && p){ links.push({x1:p.x,y1:p.y,x2:g.x,y2:g.y}); }
    });
  });

  links.forEach(L=>{
    const line = document.createElementNS(NS,'line');
    line.setAttribute('class','link');
    line.setAttribute('x1', L.x1); line.setAttribute('y1', L.y1);
    line.setAttribute('x2', L.x2); line.setAttribute('y2', L.y2);
    svg.appendChild(line);
  });

  DATA.items.forEach(it=>{
    const p = iPos.get(it.id); if(!p) return;
    const g = (it.groups && it.groups[0])? it.groups[0] : 'グループ外（自動）';
    const grpColor = g==='グループ外（自動）' ? '#94a3b8' : colorFromString(g);
    const node = document.createElementNS(NS,'g'); node.setAttribute('class','i-node');
    const c = document.createElementNS(NS,'circle'); 
    c.setAttribute('cx',p.x); c.setAttribute('cy',p.y); 
    c.setAttribute('r',10); 
    c.setAttribute('fill', '#1f2937'); 
    c.setAttribute('stroke', grpColor);

    const t = document.createElementNS(NS,'text'); 
    t.setAttribute('x', p.x+14); 
    t.setAttribute('y', p.y+4); 
    t.textContent = it.text; t.textContent = it.text; t.setAttribute('font-size','12');
    node.appendChild(c); node.appendChild(t); svg.appendChild(node);
  });

  DATA.groups.forEach(g=>{
    const p = gPos.get(g.name); if(!p) return;
    const node = document.createElementNS(NS,'g'); node.setAttribute('class','g-node');
    const c = document.createElementNS(NS,'circle'); c.setAttribute('cx',p.x); c.setAttribute('cy',p.y); c.setAttribute('r',20);
    const clr = g.name==='グループ外（自動）' ? '#94a3b8' : colorFromString(g.name);
    c.setAttribute('stroke', clr);
    const t = document.createElementNS(NS,'text'); t.setAttribute('x', p.x); t.setAttribute('y', p.y-28); t.textContent = g.name; t.setAttribute('font-size','12');
    node.appendChild(c); node.appendChild(t); svg.appendChild(node);
  });

  const legend = document.getElementById('legend'); legend.innerHTML='';
  DATA.groups.forEach(g=>{
    const chip = document.createElement('span'); chip.className='chip';
    const dot = document.createElement('span'); dot.className='dot';
    dot.style.background = g.name==='グループ外（自動）' ? 'transparent' : colorFromString(g.name);
    if(g.name==='グループ外（自動）'){ dot.style.outline='1px dashed #64748b'; }
    chip.appendChild(dot); chip.appendChild(document.createTextNode(g.name));
    legend.appendChild(chip);
  });
}

window.addEventListener('resize', layout);
layout();
<ascriptscript>
</body>
</html>`.replace("<ascript", "</");
  }

// ここから本体の処理が続く
els.saveTagsBtn.addEventListener('click', async ()=>{
  const id = state.dlgTargetId;
  const boxes = [...els.dlgGroupChecks.querySelectorAll('input[type="checkbox"]')];
  const selected = boxes.filter(b=>b.checked).map(b=>b.value);
  await updateItemGroups(id, selected);
  closeDlg();
  renderAll();
  toast('グループを更新しました');
});

els.newItem.addEventListener('keydown', (e)=>{
  if(e.key==='Enter' && !e.isComposing){
    e.preventDefault();
    els.addForm.requestSubmit();
  }
});

// ===== Init =====
(async function init(){
  try{
    state.db = await openDB();
    await loadAll();
    await migrateFromLocalStorageIfNeeded();
    renderAll();
  }catch(err){
    alert('IndexedDBの初期化に失敗しました。別ブラウザでお試しください。\n'+err);
  }
})();
})();
</script>
</body>
</html>
